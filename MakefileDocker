.PHONY: common-docker-build common-docker-push common-docker-clean common-docker-release

TEST_REGISTRY ?= localhost:5000
RELEASE_REGISTRY ?= skyuk

gitRev := $(shell git rev-parse --short HEAD)
gitTag := $(shell git tag --points-at=$(gitRev))

# Variables recursively expanded, so $(image) can be set before/after including this file
dockerTestImage = $(TEST_REGISTRY)/$(image):v$(gitRev)
dockerReleaseCandidateImage = $(RELEASE_REGISTRY)/$(image):v$(gitRev)
dockerReleaseImage = $(RELEASE_REGISTRY)/$(image):$(gitTag)
dockerReleaseLatestImage = $(RELEASE_REGISTRY)/$(image):latest

common-docker-build:
	@echo "== common-docker-build"
	@echo "Building image $(dockerTestImage)"
	docker build . -t $(dockerTestImage)

common-docker-push:
	@echo "== common-docker-push"
	@echo "Pushing image $(dockerTestImage)"
	docker push $(dockerTestImage)

common-docker-clean:
	@echo "== common-docker-clean"
	docker rm $(dockerTestImage) || true

common-docker-release:
	@echo "== common-docker-release"
ifeq ($(strip $(gitTag)),)
	@echo "Releasing candidate based on rev: $(gitRev). Docker image: $(dockerReleaseCandidateImage)"
	@echo "$(DOCKER_PASSWORD)" | docker login -u $(DOCKER_USERNAME) --password-stdin
	docker tag $(dockerTestImage) $(dockerReleaseCandidateImage)
	docker push $(dockerReleaseCandidateImage)
else
	@echo "Releasing based on tag: $(gitTag). Docker image: $(dockerReleaseImage)"
	@echo "$(DOCKER_PASSWORD)" | docker login -u $(DOCKER_USERNAME) --password-stdin
	docker pull $(dockerReleaseCandidateImage)
	docker tag $(dockerReleaseCandidateImage) $(dockerReleaseImage)
	docker tag $(dockerReleaseCandidateImage) $(dockerReleaseLatestImage)
	docker push $(dockerReleaseImage)
	docker push $(dockerReleaseLatestImage)
endif
